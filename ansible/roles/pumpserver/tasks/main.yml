---
- git:
    repo: https://github.com/1NTERRUPT/water-processing
    dest: /srv/pumpserver

- name: Get variables
  include_vars:
    file: ./files/vars.yml

- name: Set time zone
  timezone:
    name: "{{ timezone }}"

- name: Setup server permissions
  file:
    path: /srv/pumpserver/
    state: directory
    owner: ubuntu
    group: ubuntu
    recurse: yes

- name: Install Packages
  apt: name={{ item }} update_cache=yes state=latest
  with_items:
    - build-essential
    - npm
    - nodejs-legacy
    - mcrypt
    - nginx
    - curl
    - ruby2.4
    - ruby2.4-dev
    - ruby-switch
    - sqlite3 
    - libsqlite3-dev
    - bsdgames

- name: Set Ruby 2.4 as default
  command: ruby-switch --set ruby2.4
  become: yes

- apt: name=ruby-bundler update_cache=yes state=latest force=yes
  become: yes

- name: Install Bundler
  gem: name=bundler state=latest
  user_install: no
  executable: yes
  become: yes

- name: Really install bundler
  command: gem install bundler
  become: yes

- name: Install pumpserver
  bundler:
      state: present
      chdir: /srv/pumpserver
  become: no

- name: migrate database
  command: bundle exec rake db:migrate chdir=/srv/pumpserver
  become: no

- name: tmp clear
  command: bundle exec rake tmp:clear chdir=/srv/pumpserver
  become: no

- name: log clear
  command: bundle exec rake log:clear chdir=/srv/pumpserver
  become: no

- name: setup seed data
  command: bundle exec rake db:seed chdir=/srv/pumpserver
  become: no

- name: update cron jobs
  command: bundle exec whenever --update-crontab --set environment='development' chdir=/srv/pumpserver
  become: no

- name: disable default nginx site
  file: 
    path: /etc/nginx/sites-enabled/default
    state: absent
  become: yes

- template:
    src: templates/nginx.j2
    dest: /etc/nginx/sites-enabled/pumpserver

- template:
    src: templates/pumpserver.j2
    dest: /etc/init/pumpserver.conf
  become: yes

- service:
    name: pumpserver
    state: restarted

- service:
    name: nginx
    state: restarted

- name: Create generic ops user
  user:
    name: "{{ item.name }}"
    password: "{{ item.password }}"
  loop: "{{ ops_acct }}"

- name: Create ops user home directory
  file:
    path: /home/{{ item.name }}/
    state: directory
    owner: "{{ item.name }}"
    group: "{{ item.name }}"
    mode: 0755
  loop: "{{ ops_acct }}"

- name: Copy content to ops user home directory
  copy:
    src: "{{ content_folder }}pumpshmi01/home/{{ item.name }}/"
    dest: /home/{{ item.name }}/
  loop: "{{ ops_acct }}"

- name: Make marco script executable
  file:
    path: /home/{{ item.name }}/marco
    mode: +x
  loop: "{{ ops_acct }}"

- name: Make ftp script executable
  file:
    path: /home/{{ item.name }}/ftpput
    mode: +x
  loop: "{{ ops_acct }}"

- name: Create marco cron job
  cron:
    name: Run marco
    minute: "*/1"
    hour: "*"
    job: /home/{{ item.name }}/marco
  loop: "{{ ops_acct }}"

- name: Create ftp cron job
  cron:
    name: Run ftpput
    minute: "10"
    hour: "*"
    job: /home/{{ ops_acct }}/ftpput

